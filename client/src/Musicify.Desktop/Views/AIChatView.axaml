<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Musicify.Core.ViewModels"
             xmlns:models="using:Musicify.Core.Models"
             xmlns:converters="using:Musicify.Desktop.Views"
             x:Class="Musicify.Desktop.Views.AIChatView"
             x:DataType="vm:AIChatViewModel">
    
    <Grid RowDefinitions="Auto,*,Auto">
        <!-- å·¥å…·æ  -->
        <Border Grid.Row="0" 
                Background="#FAFAFA" 
                BorderBrush="#E5E7EB" 
                BorderThickness="0,0,0,1" 
                Padding="10,5">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="ðŸ¤– AI å¯¹è¯" 
                              FontSize="18" 
                              FontWeight="Bold"
                              Foreground="#1F2937"
                              VerticalAlignment="Center" />
                    <Separator />
                    <TextBlock Text="åˆ›ä½œæ¨¡å¼:" 
                              Foreground="#6B7280"
                              VerticalAlignment="Center" />
                    <ComboBox SelectedItem="{Binding CreationMode, Mode=TwoWay}"
                             ItemsSource="{Binding CreationModes}"
                             MinWidth="120" />
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                    <TextBlock IsVisible="{Binding TokenUsage, Converter={x:Static converters:IsNotNullConverter.Instance}}">
                        <Run Text="Token: " Foreground="#6B7280" />
                        <Run Text="{Binding TokenUsage.TotalTokens}" 
                             Foreground="#1F2937" FontWeight="SemiBold" />
                    </TextBlock>
                    <Button Content="ðŸ—‘ï¸ æ¸…ç©º" 
                           Command="{Binding ClearHistoryCommand}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <ScrollViewer Grid.Row="1" 
                     Name="MessageScrollViewer"
                     Background="#FFFFFF"
                     VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Messages}" 
                         Margin="20">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="models:ChatMessage">
                        <Border Margin="0,10,0,0" 
                               Padding="15"
                               Background="{Binding Type, Converter={x:Static converters:StringToBrushConverter.Instance}}"
                               CornerRadius="8"
                               Name="MessageBorder">
                            <Grid RowDefinitions="Auto,*,Auto">
                                <!-- æ¶ˆæ¯å¤´éƒ¨ -->
                                <Grid Grid.Row="0" ColumnDefinitions="Auto,*">
                                    <TextBlock Grid.Column="0" 
                                              Text="{Binding Type, Converter={x:Static converters:MessageTypeToIconConverter.Instance}}"
                                              FontSize="16"
                                              Margin="0,0,10,0" />
                                    <TextBlock Grid.Column="1" 
                                              Text="{Binding Type, Converter={x:Static converters:MessageTypeToLabelConverter.Instance}}"
                                              FontWeight="Bold"
                                              Foreground="#1F2937" />
                                </Grid>
                                
                                <!-- æ¶ˆæ¯å†…å®¹ -->
                                <Grid Grid.Row="1" Margin="0,10,0,10">
                                    <TextBlock Text="{Binding Content}"
                                              TextWrapping="Wrap"
                                              Foreground="#1F2937"
                                              FontSize="14"
                                              LineHeight="24"
                                              Name="MessageContent" />
                                    <!-- æµå¼ç”ŸæˆæŒ‡ç¤ºå™¨ -->
                                    <TextBlock IsVisible="{Binding IsStreaming}"
                                              Text="â–Š"
                                              Foreground="#3B82F6"
                                              FontSize="14"
                                              Margin="2,0,0,0"
                                              Opacity="0.8"
                                              Name="StreamingIndicator">
                                        <TextBlock.RenderTransform>
                                            <TranslateTransform X="0" />
                                        </TextBlock.RenderTransform>
                                        <TextBlock.Styles>
                                            <Style Selector="TextBlock">
                                                <Style.Animations>
                                                    <Animation Duration="0:0:1" IterationCount="Infinite">
                                                        <KeyFrame Cue="0%">
                                                            <Setter Property="Opacity" Value="1.0" />
                                                        </KeyFrame>
                                                        <KeyFrame Cue="50%">
                                                            <Setter Property="Opacity" Value="0.3" />
                                                        </KeyFrame>
                                                        <KeyFrame Cue="100%">
                                                            <Setter Property="Opacity" Value="1.0" />
                                                        </KeyFrame>
                                                    </Animation>
                                                </Style.Animations>
                                            </Style>
                                        </TextBlock.Styles>
                                    </TextBlock>
                                </Grid>
                                
                                <!-- æ¶ˆæ¯åº•éƒ¨ -->
                                <Grid Grid.Row="2" ColumnDefinitions="*,Auto">
                                    <TextBlock Grid.Column="0" 
                                              Text="{Binding Timestamp, StringFormat='æ—¶é—´: {0:HH:mm}'}"
                                              FontSize="12"
                                              Foreground="#6B7280" />
                                    <TextBlock Grid.Column="1" 
                                              IsVisible="{Binding TokenCount, Converter={x:Static converters:IsNotNullConverter.Instance}}">
                                        <Run Text="Token: " Foreground="#6B7280" />
                                        <Run Text="{Binding TokenCount}" 
                                             Foreground="#1F2937" FontWeight="SemiBold" />
                                    </TextBlock>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <Border Grid.Row="2" 
                Background="#F5F7FA" 
                BorderBrush="#E5E7EB" 
                BorderThickness="0,1,0,0" 
                Padding="15">
            <Grid RowDefinitions="Auto,Auto">
                <!-- é”™è¯¯æ¶ˆæ¯ -->
                <TextBlock Grid.Row="0" 
                          Text="{Binding ErrorMessage}"
                          Foreground="#DC2626"
                          FontSize="12"
                          Margin="0,0,0,10"
                          IsVisible="{Binding ErrorMessage, Converter={x:Static converters:IsNotNullConverter.Instance}}" />
                
                <!-- è¾“å…¥æ¡†å’ŒæŒ‰é’® -->
                <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto">
                    <TextBox Grid.Column="0" 
                            Text="{Binding InputText, Mode=TwoWay}"
                            Watermark="è¯·è¾“å…¥æ‚¨çš„åˆ›ä½œéœ€æ±‚..."
                            AcceptsReturn="True"
                            TextWrapping="Wrap"
                            MinHeight="60"
                            MaxHeight="120"
                            Margin="0,0,10,0" />
                    <Button Grid.Column="1" 
                           Content="â¹ï¸ åœæ­¢"
                           Command="{Binding StopGenerationCommand}"
                           IsEnabled="{Binding IsGenerating}"
                           Margin="0,0,10,0"
                           IsVisible="{Binding IsGenerating}" />
                    <Button Grid.Column="2" 
                           Content="ðŸ“¤ å‘é€"
                           Command="{Binding SendMessageCommand}"
                           Padding="20,10" />
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
